---
title: "Fisher Water Quality Monitoring"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# load libraries
if (!require(librarian)) install.packages("librarian"); library(librarian)
shelf(
  flexdashboard,
  fs, here, glue, digest,
  tibble, readr, dplyr,
  ggplot2,
  leaflet, sf, raster,
  marmap, mikkovihtakari/PlotSvalbard)
select = dplyr::select

dir_data <- here("data")

csvs <- list.files(dir_data, ".*csv$", full.names = T)

csv <- csvs[2]

# TODO: avg lon/lat

pts <- read_csv(csv) %>%
  rename(
    lon = "Longitude (°)", 
    lat = "Latitude (°)") %>% 
  filter(
    !is.na(lon),
    !is.na(lat)) %>% 
  st_as_sf(
    coords = c("lon", "lat"), crs = 4326, remove = F)

# get bottom depth
bb <- pts %>% 
  st_buffer(0.8) %>% 
  st_bbox()
# TODO: download hi res from [Bathymetric Data Viewer](https://maps.ngdc.noaa.gov/viewers/bathymetry/)
# try: Digital Elevation Model: Florida and East Gulf of Mexico (3 arc-second)

# cache bathymetry given bounding box (using a hash)
bathy_tif <- glue("{dir_data}/bathy_{digest(bb)}.tif")
if (!file.exists(bathy_tif)){
  r_bathy <- getNOAA.bathy(bb$xmin, bb$xmax, bb$ymin, bb$ymax, resolution = 1) %>% 
    as.raster()
  writeRaster(r_bathy, bathy_tif)  
} else {
  r_bathy <- raster(bathy_tif)
}

d <- pts %>%
  rename(
    dtime  = "Date Time",
    depth  = "Depth (ft)",
    temp   = "Temperature (°C)",
    oxygen = "Oxygen Partial Pressure (Torr)") %>% 
  filter(
    !is.na(depth),
    !is.na(temp)) %>% 
  arrange(dtime) %>% 
  st_drop_geometry() # %>% 
  # as.data.frame()

# select(d, dtime, depth ,depth_dif) %>% View()
# d

# filter for downcast (not up)
row_end <- which.max(d$depth)
d <- d[1:row_end,]
# filter out surface entries (< 5 m), except row immediately before
row_beg <- max(which(d$depth < 5)) - 1
d <- d[row_beg:nrow(d),]

d$bdepth <- extract(r_bathy, pts %>% as("Spatial")) * -1
if (max(d$depth) > max(d$bdepth))
  d$bdepth <- d$bdepth + (max(d$depth) - max(d$bdepth))
```

Column {.tabset data-width=650}
-----------------------------------------------------------------------

### Map, dynamic

```{r}
leaflet(pts) %>% 
  addProviderTiles(providers$Esri.OceanBasemap) %>% 
  addMarkers()
```

### Map, static

```{r}
blues <- c("lightsteelblue4", "lightsteelblue3",
           "lightsteelblue2", "lightsteelblue1")
greys <- c(grey(0.6), grey(0.93), grey(0.99))

bathy <- r_bathy %>% as.bathy()

plot(bathy, image = TRUE, land = TRUE, lwd = 0.03,
        bpal = list(c(0, max(bathy), greys),
        c(min(bathy), 0, blues)))

plot(bathy, n = 1, lwd = 0.4, add = TRUE) # coastline

points(pts %>% as("Spatial"), col = "red")
```


Column {data-width=350}
-----------------------------------------------------------------------

### Temperature

```{r}
# TODO add bottom_depth to points
contours = seq(
  min(d$temp), max(d$temp), length.out=5)[c(-1,-5)]
section_plot(
  d, x = "lon", y = "depth", 
  z = "temp", bottom = "bdepth", sampling_indicator = "points",
  interpolate  = T, contour = contours, contour_color = "gray")
# TODO: customize https://github.com/MikkoVihtakari/PlotSvalbard/blob/master/R/section_plot.R
```

### Oxygen

```{r}
contours = seq(
  min(d$oxygen), max(d$oxygen), length.out=5)[c(-1,-5)]

section_plot(
  d, x = "lon", y = "depth", 
  z = "oxygen", bottom = "bdepth", sampling_indicator = "points",
  interpolate  = T, contour = contours, contour_color = "gray")
```

