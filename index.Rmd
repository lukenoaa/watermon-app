---
title: "Fisher Water Quality Monitoring"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# load libraries
if (!require(librarian)) install.packages("librarian"); library(librarian)
shelf(
  flexdashboard,
  fs, here, glue, digest,
  tibble, readr, dplyr,
  ggplot2,
  leaflet, sf, raster,
  marmap, mikkovihtakari/PlotSvalbard)
select = dplyr::select

dir_data <- here("data/Test Data")

csvs <- list.files(dir_data, "processed.*csv$", full.names = T)

csv <- csvs[1]

d <- read_csv(csv)

pts <- d  %>%
  group_by(csv, lon_dd, lat_dd) %>% 
  summarize(n = n()) %>% 
  st_as_sf(
    coords = c("lon_dd", "lat_dd"), crs = 4326, remove = F)

ln <- pts %>% st_coordinates() %>% st_linestring()

ctr <- ln %>% st_centroid() %>% st_coordinates()
```

Column {.tabset data-width=650}
-----------------------------------------------------------------------

### Map, dynamic

```{r}
leaflet(ln) %>% 
  addProviderTiles(providers$Esri.OceanBasemap) %>% 
  addPolylines() %>% 
  addCircleMarkers(data = pts, stroke = F, radius = 5) %>% 
  setView(ctr[1], ctr[2], zoom = 10)
```

### Map, static

```{r, eval=F}
blues <- c("lightsteelblue4", "lightsteelblue3",
           "lightsteelblue2", "lightsteelblue1")
greys <- c(grey(0.6), grey(0.93), grey(0.99))

bathy <- r_bathy %>% as.bathy()

plot(bathy, image = TRUE, land = TRUE, lwd = 0.03,
        bpal = list(c(0, max(bathy), greys),
        c(min(bathy), 0, blues)))

plot(bathy, n = 1, lwd = 0.4, add = TRUE) # coastline

points(pts %>% as("Spatial"), col = "red")
```


Column {data-width=350}
-----------------------------------------------------------------------

### Temperature

```{r}
# TODO add bottom_depth to points
contours = seq(
  min(d$temp_c), max(d$temp_c), length.out=5)[c(-1,-5)]
section_plot(
  d %>% data.frame(), x = "lon_dd", y = "depth_ft", 
  z = "temp_c", bottom = "bdepth_ft", sampling_indicator = "points",
  interpolate  = T, contour = contours, contour_color = "gray")
# TODO: customize https://github.com/MikkoVihtakari/PlotSvalbard/blob/master/R/section_plot.R
```

### Oxygen

```{r}
contours = seq(
  min(d$oxygen_torr), max(d$oxygen_torr), length.out=5)[c(-1,-5)]

section_plot(
  d %>% data.frame(), x = "lon_dd", y = "depth_ft", 
  z = "oxygen_torr", bottom = "bdepth_ft", sampling_indicator = "points",
  interpolate  = T, contour = contours, contour_color = "gray")
```

